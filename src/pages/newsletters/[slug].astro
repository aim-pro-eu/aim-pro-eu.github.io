---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.vue';
import LinkedInFeed from '../../components/LinkedInFeed.vue';
import Footer from '../../components/Footer.vue';
import PdfPrintButton from '../../components/PdfPrintButton.vue';

export async function getStaticPaths() {
  const newsletters = await getCollection('newsletters');
  return newsletters.map(nl => ({
    params: { slug: nl.slug },
    props: { newsletter: nl },
  }));
}

const { newsletter } = Astro.props;
const { Content } = await newsletter.render();

const formattedDate = new Intl.DateTimeFormat('en-GB', {
  day: 'numeric', month: 'long', year: 'numeric'
}).format(newsletter.data.date);
---

<Layout title={`${newsletter.data.title} | AIM-PRO`}>
  <!-- Classe 'no-print' pour cacher la nav lors de l'export PDF -->
  <div class="no-print">
    <Navbar client:load />
  </div>

  <!-- Le contenu principal -->
  <main class="pt-24 pb-20 bg-white min-h-screen print:pt-0 print:pb-0 print:bg-white">
    <!-- Conteneur format A4 simulé pour l'écran -->
    <article class="max-w-4xl mx-auto px-8 sm:px-12 py-8 bg-white print:max-w-none print:px-0 print:py-0">
      
      <!-- Bouton Retour & Print (Cachés à l'impression) -->
      <div class="no-print flex justify-between items-center mb-12">
        <a href="/newsletters" class="inline-flex items-center text-sm text-slate-500 hover:text-blue-700">
          &larr; Back to Newsletters
        </a>
        <!-- Le bouton Vue qui déclenche l'impression -->
        <PdfPrintButton client:load />
      </div>

      <!-- En-tête Newsletter -->
      <header class="mb-10 text-center border-b-2 border-blue-900 pb-8">
        <div class="flex justify-between items-end mb-6">
            <!-- Logo Projet (Visible sur le PDF) -->
            <div class="text-left">
                <span class="block text-2xl font-bold text-blue-900">AIM-PRO</span>
                <span class="text-sm text-slate-500">Erasmus+ Project</span>
            </div>
            <div class="text-right">
                <span class="block text-sm font-semibold text-slate-600 uppercase tracking-wider">Newsletter</span>
                <time datetime={newsletter.data.date.toISOString()} class="text-blue-700 font-bold">{formattedDate}</time>
            </div>
        </div>

        <h1 class="text-4xl font-extrabold text-slate-900 text-left leading-tight">
          {newsletter.data.title}
        </h1>

        {newsletter.data.coverImage && (
          <div class="rounded-xl overflow-hidden shadow-sm mt-8 print:shadow-none print:border print:border-slate-200">
            <img src={newsletter.data.coverImage} alt="" class="w-full h-64 object-cover print:h-auto print:max-h-80" />
          </div>
        )}
      </header>

      <!-- Contenu Markdown (Prose) -->
      <!-- 'print:prose-sm' réduit légèrement la police pour économiser du papier -->
      <div class="prose prose-lg prose-slate prose-blue mx-auto text-justify print:prose-sm print:max-w-none">
        <Content />
      </div>

      <!-- Section Social Watch (Saut de page avant si nécessaire) -->
      {newsletter.data.linkedinPosts && newsletter.data.linkedinPosts.length > 0 && (
        <div class="mt-12 pt-8 border-t border-slate-200 break-before-auto">
            <h3 class="text-xl font-bold text-slate-900 mb-6">Social Media Highlights</h3>
            <LinkedInFeed posts={newsletter.data.linkedinPosts} />
        </div>
      )}

      <!-- Pied de page spécial PDF -->
      <div class="hidden print:block mt-16 pt-4 border-t border-slate-300 text-center text-xs text-slate-500">
        <p>AIM-PRO Project - 101245864 | Funded by the European Union</p>
        <p>Read more at: <strong>https://aim-pro.eu/newsletters/{newsletter.slug}</strong></p>
      </div>

    </article>
  </main>

  <div class="no-print">
<Footer client:visible />
  </div>
</Layout>

<style is:global>
  @media print {
    @page {
      margin: 2cm;
      size: A4;
    }
    
    body {
      background: white;
      color: black;
    }

    /* Force l'impression des couleurs de fond (pour les badges, etc) */
    * {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }

    /* Évite de couper les images ou les paragraphes en deux */
    img, h2, h3, blockquote {
      break-inside: avoid;
    }

    /* Affiche les URLs complètes des liens pour le papier */
    a[href^="http"]:after {
      content: " (" attr(href) ")";
      font-size: 0.8em;
      color: #666;
    }
    
    /* Ne pas afficher l'URL pour les images ou liens internes */
    a[href^="/"]:after, a[href^="#"]:after, .social-links a:after {
        content: "";
    }
  }
</style>